{% extends 'base.html' %}

{% block content %}
<a class="btn btn-primary adicionar_conta">Adicionar uma conta</a>
<div class="d-none form-contas d-flex justify-content-center">
  {% include 'contas_form.html' %}
</div>
<table id="contas_table">
  <thead>
    <tr>
      <th class="text-center">DATA</th>
      <th class="text-center">DESCRIÇÃO</th>
      <th class="text-center">VALOR</th>
      <th class="text-center">STATUS</th>
      <th class="text-center">DATA PAGAMENTO</th>
      <th class="text-center">PAGAR</th>
    </tr>
  </thead>
  <tbody class="tbody-contas">
    {% for conta in contas %}
      <tr class="
      {% if conta.status == 'À pagar' %} bg-info 
      {% elif conta.status == 'Paga' %} bg-success
      {% elif conta.status == 'Vencida' %} bg-danger
      {% elif conta.status == 'Vencendo' %} bg-warning
      {% endif %}">
        <td>{{conta.data_vencimento}}</td>
        <td>{{conta.descricao}}</td>
        <td>R${{conta.valor}}</td>
        <td>{{conta.status}}</td>
        <td>{{ conta.data_pagamento }}</td>
        <td><a data-descricao="{{ conta.descricao }}"
               data-id_conta="{{ conta.id }}"
               data-data_vencimento="{{conta.data_vencimento}}"
               data-valor="{{conta.valor}}" class="pagar-conta" ><i class="bi bi-check2-square"></i></a></td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<script>
  $(document).ready(function () {

    $('#contas_table').DataTable();

    $('.adicionar_conta').click(function () {
      $('.form-contas').toggleClass('d-none')
      $('.form_contas input').val('')
      $('.form_contas input').prop('checked', false)
      $('input.numero_repeticao').prop('required', false)
      $('.numero_repeticao').addClass("d-none")
    })

    $('#recorrente').change(function () { 
      $('.numero_repeticao').toggleClass("d-none")
      $('.numero_repeticao').val("")
      if ( !$('input.numero_repeticao').prop('required')) {
        $('input.numero_repeticao').prop('required', true)
      } else {
        $('input.numero_repeticao').prop('required', false)
      }      
    })

    $('.form_contas').submit(function (e) { 
        e.preventDefault()
        if ($("#recorrente").prop('checked')) {
          $("#recorrente").val(true)
        } else {
          $("#recorrente").val(false)
        }
        console.log($("#recorrente").val())
        $.ajax({
          data: {
            data_vencimento: $('#data_vencimento').val(),
            valor: $("#valor").val(),
            recorrente: $("#recorrente").val(),
            numero_repeticao: $("#numero_repeticao").val(),
            descricao: $("#descricao").val()
          },
          type: "POST",
          url: "{{url_for('lista_contas')}}",
        }).done((data) => {
          atualizar_tabela_contas()
        })
       
        function zerar_campos_contas() {
          $('#data_vencimento').val("")
          $("#valor").val("")
          $("#recorrente").val("")
          $("#numero_repeticao").val("")
          $("#descricao").val("")
        }

        function atualizar_tabela_contas() { 
          let data_vencimento = $('#data_vencimento').val()
          let valor = $("#valor").val()
          let descricao = $("#descricao").val()
          let recorrente = $("#recorrente").val()
          
          let nova_data = new Date(data_vencimento)
          let data_hoje = new Date()
          if (recorrente == "true") {
            var repeticoes = $("#numero_repeticao").val()
          } else {
            var repeticoes = 1
          }
          repeticoes = Number(repeticoes)
          zerar_campos_contas()
          for (let count = 0; count < repeticoes; count ++ ) {
            let diff = moment(nova_data,"DD/MM/YYYY").diff(moment(data_hoje,"DD/MM/YYYY"));
            let dias_diferenca = moment.duration(diff).asDays();

            let status_conta = "À pagar"
            let cor = "bg-info"
            if (Number(dias_diferenca) <= 0) {
              status_conta = "Vencida"
              cor = "bg-danger"
            } else if (Number(dias_diferenca) <= 3) {
              status_conta = "Vencendo"
              cor = "bg-warning"
            }
            let ano = nova_data.getFullYear()
            let mes = nova_data.getMonth()+1
            mes = mes < 10 ? '0'+String(mes)  : mes = mes
            let dia = nova_data.getDay()
            dia = dia < 10 ? '0'+String(dia)  : dia = dia
            let data_string = `${ano}-${mes}-${dia}`
            let new_tr = `<tr class=" ${cor} ">
                            <td>${data_string}</td>
                            <td>${descricao}</td>
                            <td>R$${valor}</td>
                            <td>${status_conta}</td>
                            <td>-</td>
                          </tr>`
            $('.tbody-contas').append(new_tr)
            let mes_atual = nova_data.getMonth()
            nova_data = new Date(nova_data.setMonth(mes_atual + 1))
          }
          
        }

        
    })

  })
  
</script>

{% endblock content %}